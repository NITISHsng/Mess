<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Purchase Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: auto;
            transition: background-color 0.3s, color 0.3s;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"], textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .form-group:last-of-type {
            display: flex;
            justify-content: flex-end;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .purchase-list {
            margin-top: 20px;
        }
        .purchase-item {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .purchase-item div {
            flex-grow: 1;
        }
        .purchase-item button {
            margin-left: 10px;
            background-color: #007bff;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            float: right;
        }
        .purchase-item button:hover {
            background-color: #0056b3;
        }
        .purchase-item .delete {
            background-color: #dc3545;
        }
        .purchase-item .delete:hover {
            background-color: #c82333;
        }
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #editModal .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        #editModal textarea {
            width: 90%;
        }
       .save-button{
          position: relative;
          bottom: 40px;
          display: flex;
          justify-content: right;
        }
  
   .delete-all {
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 5px 10px;
    float: left;
}

.delete-all:hover {
    background-color: #c82333;
}

        .dark-mode {
            background-color: #333;
            color: #fff;
        }
        .dark-mode .container {
            background-color: #444;
            color: #fff;
        }
        .dark-mode input[type="number"], .dark-mode textarea {
            background-color: #555;
            border: 1px solid #777;
            color: #fff;
        }
        .dark-mode .purchase-item {
            background-color: #555;
        }
        .dark-mode button {
            background-color: #28a745;
            color: #fff;
        }
        .dark-mode button:hover {
            background-color: #218838;
        }
        .dark-mode .purchase-item button {
            background-color: #007bff;
        }
        .dark-mode .purchase-item button:hover {
            background-color: #0056b3;
        }
        .dark-mode .purchase-item .delete {
            background-color: #dc3545;
        }
        .dark-mode .purchase-item .delete:hover {
            background-color: #c82333;
        }
        .dark-mode .delete-all {
            background-color: #dc3545;
        }
        .dark-mode .delete-all:hover {
            background-color: #c82333;
        }
        
.switch {
  position: relative;
  display: inline-block;
  width: 50px; /* Adjusted width */
  height: 24px; /* Adjusted height */
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px; /* Adjusted height */
  width: 20px; /* Adjusted width */
  left: 2px; /* Adjusted position */
  bottom: 2px; /* Adjusted position */
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 24px; /* Adjusted border-radius */
}

.slider.round:before {
  border-radius: 50%;
}

    </style>
</head>
<body>

    <div class="container">
        <h3>Market Purchase Form
  <label class="switch">
  <input type="checkbox" checked>
  <span class="slider round" onclick="toggleDarkMode()"></span>
</label>

        </h3>
       
        <div class="form-group">
            <label for="amount">Total Amount Spent (in Taka):</label>
            <input type="number" id="amount" name="amount" required>
        </div>
        <div class="form-group">
            <label for="items">Items Purchased:</label>
            <textarea id="items" name="items" required></textarea>
        </div>
        <div class="save-button" class="form-group">
            <button type="button"  onclick="addPurchase()">Save</button>
        </div>
        
        <div class="purchase-list" id="purchase-list">
            <!-- Purchase items will be added here -->
        </div>

        <div class="form-group">
            <button class="delete-all" onclick="deleteAllPurchases()">Delete All </button>
        </div>
        <div class="form-group">
            <strong>Total Amount Spent:</strong>
            <div id="totalAmount">0/-</div>
        </div>
        
    </div>

    <!-- Edit Modal -->
    <div id="editModal">
        <div class="modal-content">
            <label for="editAmount">Edit Amount:</label>
            <input type="number" id="editAmount" required><br><br>
            <label for="editItems">Edit Items:</label>
            <textarea id="editItems" required></textarea><br><br>
            <button onclick="saveEdit()">Save</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBfQErg1fpq6v0uTeZHsn3VRGeaUGU8CnY",
            authDomain: "mess-e8b2b.firebaseapp.com",
            projectId: "mess-e8b2b",
            storageBucket: "mess-e8b2b.appspot.com",
            messagingSenderId: "1097476946862",
            appId: "1:1097476946862:web:cc6a252a88ce145923263f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const userId = '21102002'; // Your user ID

        let currentEditElement;

        function addPurchase() {
            const amount = document.getElementById('amount').value;
            const items = document.getElementById('items').value;
            const date = new Date().toLocaleDateString('en-GB').split('/').join('-');

            if (amount && items) {
                const purchase = {
                    amount: amount,
                    items: items,
                    date: date
                };

                db.collection('User').doc(userId).collection('Purchases').add(purchase)
                    .then(docRef => {
                        console.log("Document written with ID: ", docRef.id);
                        displayPurchase(purchase, docRef.id);
                        updateTotalAmount();
                    })
                    .catch(error => {
                        console.error("Error adding document: ", error);
                    });

                // Clear inputs
                document.getElementById('amount').value = '';
                document.getElementById('items').value = '';
            }
        }

        function displayPurchase(purchase, id) {
            const purchaseList = document.getElementById('purchase-list');
            const purchaseItem = document.createElement('div');
            purchaseItem.className = 'purchase-item';
            purchaseItem.dataset.id = id;

            purchaseItem.innerHTML = `
                <div>
                    <strong>${purchase.amount}/-</strong><br>
                    ${purchase.date}
                </div>
                <div>
                    <button onclick="viewItems(this)"><i class="fa-solid fa-cart-shopping"></i></button>
                    <button class="delete" onclick="deletePurchase(this)"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="openEditModal(this)"><i class="fa-solid fa-pen"></i></button>
                </div>
                <div class="items" style="display: none;">${purchase.items.replace(/\n/g, "<br>")}</div>
            `;

            purchaseList.insertBefore(purchaseItem, purchaseList.firstChild);
        }

        function updateTotalAmount() {
            let total = 0;
            document.querySelectorAll('.purchase-item strong').forEach(el => {
                const amount = parseFloat(el.innerText.split('/')[0]);
                total += amount;
            });
            document.getElementById('totalAmount').innerText = `${total}/-`;
        }

        function openEditModal(button) {
            currentEditElement = button.parentNode.parentNode;
            document.getElementById('editAmount').value = currentEditElement.querySelector('strong').innerText.split('/')[0];
            document.getElementById('editItems').value = currentEditElement.querySelector('.items').innerHTML.replace(/<br>/g, "\n");
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const newAmount = document.getElementById('editAmount').value;
            const newItems = document.getElementById('editItems').value;
            const id = currentEditElement.dataset.id;

            if (newAmount && newItems) {
                db.collection('User').doc(userId).collection('Purchases').doc(id).update({
                    amount: newAmount,
                    items: newItems
                })
                .then(() => {
                    currentEditElement.querySelector('strong').innerText = `${newAmount}/-`;
                    currentEditElement.querySelector('.items').innerHTML = newItems.replace(/\n/g, "<br>");
                    closeModal();
                    updateTotalAmount();
                })
                .catch(error => {
                    console.error("Error updating document: ", error);
                });
            }
        }

        function deletePurchase(button) {
            let conf = confirm('Delete this item?');
            if (conf == true) {
                const purchaseItem = button.parentNode.parentNode;
                const id = purchaseItem.dataset.id;

                db.collection('User').doc(userId).collection('Purchases').doc(id).delete()
                    .then(() => {
                        console.log("Document successfully deleted!");
                        purchaseItem.remove();
                        updateTotalAmount();
                    })
                    .catch(error => {
                        console.error("Error removing document: ", error);
                    });
            }
        }

        function viewItems(button) {
            const items = button.parentNode.nextElementSibling.innerHTML.replace(/<br>/g, "\n");
            alert(`Items Purchased:\n${items}`);
        }

        function fetchPurchases() {
            db.collection('User').doc(userId).collection('Purchases').get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        displayPurchase(doc.data(), doc.id);
                    });
                    updateTotalAmount();
                })
                .catch(error => {
                    console.error("Error getting documents: ", error);
                });
        }
        
        function deleteAllPurchases() {
            let firstConfirmation = confirm('Are you sure you want to delete all purchases?');
            if (firstConfirmation) {
                let secondConfirmation = confirm('This action cannot be undone. Are you absolutely sure?');
                if (secondConfirmation) {
                    db.collection('User').doc(userId).collection('Purchases').get()
                        .then(querySnapshot => {
                            const batch = db.batch();
                            querySnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            return batch.commit();
                        })
                        .then(() => {
                            console.log("All documents successfully deleted!");
                            document.getElementById('purchase-list').innerHTML = '';
                            updateTotalAmount();
                        })
                        .catch(error => {
                            console.error("Error removing documents: ", error);
                        });
                }
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        // Fetch purchases when the page loads
        window.onload = fetchPurchases;
        
        document.addEventListener('DOMContentLoaded', function() {
            const accessToken = localStorage.getItem('accessToken');
           // console.log(accessToken);
            if (accessToken !== 'granted') {
                alert('You cannot access this page directly.');
           window.location.href = 'manager.html';
            } else {
              localStorage.removeItem('accessToken');
            }
        });
    </script>

</body>
  </html>
      
